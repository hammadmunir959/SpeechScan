<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpeechScan - Dysarthria Recognition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@200..800&family=Inter:wght@300;400;500;600&display:swap"
        rel="stylesheet">
    <!-- Firebase Imports for Environment Context -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        if (typeof __firebase_config !== 'undefined') {
            const firebaseConfig = JSON.parse(__firebase_config);
            const app = initializeApp(firebaseConfig);
            window.db = getFirestore(app);
            window.auth = getAuth(app);

            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                signInWithCustomToken(window.auth, __initial_auth_token).catch(e => console.error("Custom token sign-in failed:", e));
            } else {
                signInAnonymously(window.auth).catch(e => console.error("Anonymous sign-in failed:", e));
            }
        }
    </script>
    <style>
        /* Modern Gradient & Glassmorphism Theme */
        :root {
            --bg-color: #000000;
            --card-bg: rgba(20, 20, 20, 0.7);
            --accent-primary: #ffffff;
            --accent-glow: rgba(255, 255, 255, 0.1);
            --text-primary: #ffffff;
            --text-secondary: #a3a3a3;
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            background-color: var(--bg-color);
            background-image:
                radial-gradient(circle at 10% 20%, rgba(255, 255, 255, 0.03) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(255, 255, 255, 0.02) 0%, transparent 40%);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        h1,
        h2,
        h3,
        .brand-font {
            font-family: 'Outfit', sans-serif;
        }

        /* Glassmorphism Classes */
        .glass-panel {
            background: rgba(15, 15, 15, 0.4);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .glass-card {
            background: linear-gradient(145deg, rgba(25, 25, 25, 0.6), rgba(10, 10, 10, 0.8));
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(148, 163, 184, 0.2);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(148, 163, 184, 0.4);
        }

        /* Animations */
        @keyframes pulse-ring {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }

            70% {
                transform: scale(1);
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }

            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }

        .recording-active {
            animation: pulse-ring 2s infinite;
            background-color: #ef4444 !important;
            /* Red-500 */
        }

        @keyframes float-up {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-enter {
            animation: float-up 0.3s ease-out forwards;
        }

        /* Custom Audio Player Styling */
        audio {
            height: 32px;
            filter: invert(1) hue-rotate(180deg);
            /* Adjust default dark player */
            opacity: 0.9;
        }
    </style>
    <!-- Lucide icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
</head>

<body class="antialiased">

    <!-- Header -->
    <header class="glass-panel sticky top-0 z-20 px-6 py-4 flex items-center justify-between shadow-lg">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-xl bg-white flex items-center justify-center shadow-lg shadow-white/10">
                <i data-lucide="waves" class="text-black w-6 h-6"></i>
            </div>
            <div>
                <h1 class="text-xl font-bold tracking-tight text-white leading-none">SpeechScan</h1>
                <p class="text-xs text-white/50 font-medium tracking-wide mt-0.5">AI DYSARTHRIA ANALYZER</p>
            </div>
        </div>

        <!-- Status Indicator -->
        <div id="connection-status"
            class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-white/5 border border-white/10">
            <div id="status-dot" class="w-1.5 h-1.5 rounded-full bg-white/30 animate-pulse"></div>
            <span id="status-text"
                class="text-[10px] font-bold uppercase tracking-widest text-white/50">Connecting</span>
        </div>
    </header>

    <!-- Main Chat Area -->
    <main id="chat-stream" class="flex-1 overflow-y-auto px-4 py-6 scroll-smooth">
        <div class="max-w-3xl mx-auto space-y-6 pb-24">

            <!-- Welcome Card -->
            <div class="glass-card rounded-2xl p-6 text-center border-t border-white/10">
                <div class="w-12 h-12 bg-white/5 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i data-lucide="mic" class="text-white w-6 h-6"></i>
                </div>
                <h2 class="text-lg font-semibold text-white mb-2">Ready to Analyze</h2>
                <p class="text-neutral-400 text-sm max-w-sm mx-auto leading-relaxed">
                    Record a voice sample or upload an audio file to detect signs of dysarthria. Analysis is powered by
                    remote AI models.
                </p>
            </div>

            <!-- Dynamic Messages will appear here -->

        </div>
    </main>

    <!-- Footer Command Center -->
    <footer
        class="fixed bottom-0 left-0 right-0 z-20 pb-6 pt-12 px-4 pointer-events-none bg-gradient-to-t from-black via-black/80 to-transparent">
        <div class="max-w-xl mx-auto flex items-end justify-center gap-6 pointer-events-auto">

            <!-- Upload Button (Secondary) -->
            <button id="upload-btn"
                class="group relative p-4 rounded-full glass-panel hover:bg-neutral-700/50 transition-all duration-300 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">
                <i data-lucide="upload-cloud"
                    class="w-6 h-6 text-neutral-300 group-hover:text-white transition-colors"></i>
                <input type="file" id="file-input" accept="audio/*" class="hidden">
            </button>

            <!-- Mic Button (Primary) -->
            <div class="relative group">
                <!-- Pulse Effect Ring -->
                <div id="mic-ring"
                    class="absolute inset-0 bg-white/10 rounded-full blur-xl scale-75 group-hover:scale-110 transition-transform duration-500">
                </div>

                <button id="record-btn"
                    class="relative w-20 h-20 rounded-full bg-white shadow-xl shadow-white/10 flex items-center justify-center transition-all duration-300 hover:scale-105 active:scale-95 disabled:opacity-50 disabled:grayscale">
                    <i id="mic-icon" data-lucide="mic" class="w-8 h-8 text-black"></i>
                </button>
            </div>

            <!-- Info/Help Button (Secondary) -->
            <button
                class="p-4 rounded-full glass-panel hover:bg-neutral-700/50 transition-all duration-300 text-neutral-300 hover:text-white">
                <i data-lucide="info" class="w-6 h-6"></i>
            </button> <!-- Placeholder for future help modal -->

        </div>

        <!-- Recording Timer & Status Text -->
        <div class="text-center mt-4 h-6">
            <p id="footer-status" class="text-sm font-medium text-neutral-400 animate-fade-in">Tap microphone to start
            </p>
        </div>
    </footer>

    <!-- Templates -->
    <template id="user-msg-template">
        <div class="message-enter flex flex-col items-end gap-1">
            <div class="glass-card bg-white/5 border-white/5 rounded-2xl rounded-tr-sm p-4 max-w-[85%] sm:max-w-md">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center">
                        <i data-lucide="user" class="w-4 h-4 text-white"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="h-8 audio-container"></div> <!-- Audio element goes here -->
                    </div>
                </div>
            </div>
            <span class="text-[10px] text-neutral-500 font-medium mr-2 timestamp">--:--</span>
        </div>
    </template>

    <template id="system-msg-template">
        <div class="message-enter flex flex-col items-start gap-1 w-full">
            <div class="glass-card rounded-2xl rounded-tl-sm p-0 overflow-hidden w-full max-w-lg shadow-xl">
                <!-- Header -->
                <div class="bg-white/5 px-5 py-3 border-b border-white/5 flex justify-between items-center">
                    <span class="text-xs font-bold text-white uppercase tracking-wider">Analysis Report</span>
                    <div
                        class="flex items-center gap-1.5 status-badge px-2 py-0.5 rounded text-[10px] font-bold bg-white/5 text-white/50 border border-white/10">
                        <span class="w-1.5 h-1.5 rounded-full bg-current"></span>
                        <span class="status-label">PENDING</span>
                    </div>
                </div>

                <!-- Content -->
                <div class="p-5 space-y-4">
                    <!-- Metrics Grid -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="col-span-1 bg-neutral-800/50 rounded-lg p-3 border border-white/5">
                            <p class="text-[10px] text-neutral-400 uppercase font-semibold mb-1">Clarity Score</p>
                            <div class="flex items-end gap-1">
                                <span class="text-xl font-bold text-white clarity-val">--</span>
                                <span class="text-xs text-neutral-500 mb-1">/100</span>
                            </div>
                        </div>
                        <div class="col-span-1 bg-neutral-800/50 rounded-lg p-3 border border-white/5">
                            <p class="text-[10px] text-neutral-400 uppercase font-semibold mb-1">Speech Rate</p>
                            <span class="text-xl font-bold text-white rate-val">--</span>
                        </div>
                    </div>

                    <!-- Notes -->
                    <div>
                        <p class="text-[10px] text-neutral-400 uppercase font-semibold mb-2">Acoustic Observations</p>
                        <p class="text-sm text-neutral-300 leading-relaxed notes-text">Analysis in progress...</p>
                    </div>
                </div>
            </div>
            <span class="text-[10px] text-neutral-500 font-medium ml-2 timestamp">--:--</span>
        </div>
    </template>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();

            // Config
            const API_ENDPOINT = '/predict';

            // State
            let isRecording = false;
            let mediaRecorder = null;
            let audioChunks = [];
            let startTime = 0;
            let timerInterval;

            // Elements
            const recordBtn = document.getElementById('record-btn');
            const uploadBtn = document.getElementById('upload-btn');
            const fileInput = document.getElementById('file-input');
            const micIcon = document.getElementById('mic-icon');
            const micRing = document.getElementById('mic-ring');
            const statusText = document.getElementById('footer-status');
            const chatStream = document.getElementById('chat-stream');
            const chatContainer = chatStream.firstElementChild; // .max-w-3xl container

            const connectionStatusDot = document.getElementById('status-dot');
            const connectionStatusText = document.getElementById('status-text');

            // --- WebSocket Connection ---
            const wsUrl = (window.location.protocol === 'https:' ? 'wss:' : 'ws:') + '//' + window.location.host + '/ws';
            let ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                connectionStatusDot.classList.remove('bg-white/30', 'animate-pulse');
                connectionStatusDot.classList.add('bg-white');
                connectionStatusText.textContent = "System Ready";
                connectionStatusText.classList.replace('text-white/50', 'text-white');
            };

            ws.onclose = () => {
                connectionStatusDot.classList.remove('bg-white');
                connectionStatusDot.classList.add('bg-white/20');
                connectionStatusText.textContent = "Disconnected";
                connectionStatusText.classList.replace('text-white', 'text-white/30');
            };

            // --- Helper Functions ---
            const formatTime = (ms) => {
                const secs = Math.floor(ms / 1000);
                const mins = Math.floor(secs / 60);
                return `${mins}:${(secs % 60).toString().padStart(2, '0')}`;
            };

            const getCurrentTime = () => new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            const scrollToBottom = () => {
                chatStream.scrollTo({ top: chatStream.scrollHeight, behavior: 'smooth' });
            };

            // --- UI Builders ---
            const appendUserAudio = (blob) => {
                const url = URL.createObjectURL(blob);
                const template = document.getElementById('user-msg-template').content.cloneNode(true);

                const audio = document.createElement('audio');
                audio.controls = true;
                audio.src = url;
                audio.className = "w-full";

                template.querySelector('.audio-container').appendChild(audio);
                template.querySelector('.timestamp').textContent = getCurrentTime();

                chatContainer.appendChild(template);
                lucide.createIcons();
                scrollToBottom();
            };

            const appendSystemReport = (data) => {
                const template = document.getElementById('system-msg-template').content.cloneNode(true);
                const root = template.firstElementChild; // The wrapper div

                // Populate Data
                const badge = template.querySelector('.status-badge');
                const label = template.querySelector('.status-label');
                const clarityVal = template.querySelector('.clarity-val');
                const rateVal = template.querySelector('.rate-val');
                const notes = template.querySelector('.notes-text');
                template.querySelector('.timestamp').textContent = getCurrentTime();

                // Logic for styling based on status
                if (data.status.includes('Normal')) {
                    badge.classList.replace('bg-white/5', 'bg-white');
                    label.textContent = 'HEALTHY';
                    label.classList.replace('text-white/50', 'text-black');
                } else {
                    badge.classList.replace('bg-white/5', 'bg-neutral-800');
                    label.textContent = 'DETECTED';
                    label.classList.replace('text-white/50', 'text-white');
                }

                clarityVal.textContent = data.clarityScore || "N/A";
                rateVal.textContent = data.speechRate || "N/A";
                notes.textContent = data.acousticNotes || "No specific anomalies detected.";

                chatContainer.appendChild(template);
                scrollToBottom();
            };

            const appendError = (msg) => {
                const div = document.createElement('div');
                div.className = "glass-card border-red-500/30 p-4 rounded-xl message-enter max-w-md";
                div.innerHTML = `<div class="flex items-start gap-3">
                    <i data-lucide="alert-triangle" class="text-red-500 w-5 h-5 mt-0.5"></i>
                    <div>
                        <h4 class="text-sm font-bold text-red-400">Analysis Error</h4>
                        <p class="text-xs text-neutral-300 mt-1">${msg}</p>
                    </div>
                 </div>`;
                chatContainer.appendChild(div);
                lucide.createIcons();
                scrollToBottom();
            }

            // --- API Interaction ---
            const uploadAndAnalyze = async (blob) => {
                statusText.textContent = "Uploading & Analyzing...";
                recordBtn.disabled = true;
                micIcon.innerHTML = `<span class="animate-spin block border-2 border-white/30 border-t-white rounded-full w-6 h-6"></span>`;

                const formData = new FormData();
                formData.append('file', blob, 'recording.webm');

                try {
                    const res = await fetch(API_ENDPOINT, { method: 'POST', body: formData });
                    if (!res.ok) throw new Error(await res.text());

                    const { job_id } = await res.json();
                    statusText.textContent = "Processing...";

                    // Poll for results
                    const poll = setInterval(async () => {
                        try {
                            const pollRes = await fetch(`/results/${job_id}`);
                            const data = await pollRes.json();

                            if (data.status === 'completed') {
                                clearInterval(poll);
                                appendSystemReport(data.result);
                                resetUI();
                            } else if (data.status === 'failed') {
                                clearInterval(poll);
                                throw new Error(data.error);
                            }
                        } catch (e) {
                            clearInterval(poll);
                            appendError(e.message);
                            resetUI();
                        }
                    }, 2000);

                } catch (e) {
                    appendError(e.message);
                    resetUI();
                }
            };

            const resetUI = () => {
                recordBtn.disabled = false;
                uploadBtn.disabled = false;
                statusText.textContent = "Tap microphone to start";
                micIcon.innerHTML = ""; // Clear spinner
                const icon = document.createElement('i'); // Recreate lucide icon
                icon.setAttribute('data-lucide', 'mic');
                icon.className = "w-8 h-8 text-black";
                micIcon.appendChild(icon);
                lucide.createIcons();
            };

            // --- Capture Logic ---
            const startRecording = async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];

                    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                    mediaRecorder.onstop = () => {
                        const blob = new Blob(audioChunks, { type: 'audio/webm' });
                        appendUserAudio(blob);
                        uploadAndAnalyze(blob);
                    };

                    mediaRecorder.start();
                    isRecording = true;
                    startTime = Date.now();

                    // UI Updates
                    recordBtn.classList.add('recording-active');
                    micIcon.innerHTML = `<i data-lucide="square" class="w-8 h-8 text-white fill-current"></i>`;
                    lucide.createIcons();
                    uploadBtn.disabled = true;

                    timerInterval = setInterval(() => {
                        const elapsed = Date.now() - startTime;
                        statusText.textContent = `Recording... ${formatTime(elapsed)}`;
                    }, 1000);

                } catch (e) {
                    console.error(e);
                    alert("Cannot access microphone.");
                }
            };

            const stopRecording = () => {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(t => t.stop());
                clearInterval(timerInterval);
                isRecording = false;

                // UI Updates
                recordBtn.classList.remove('recording-active');
            };

            // --- Event Listeners ---
            recordBtn.addEventListener('click', () => {
                if (isRecording) stopRecording();
                else startRecording();
            });

            uploadBtn.addEventListener('click', () => fileInput.click());

            fileInput.addEventListener('change', (e) => {
                if (e.target.files[0]) {
                    const file = e.target.files[0];
                    appendUserAudio(file);
                    uploadAndAnalyze(file);
                    fileInput.value = ''; // Reset
                }
            });
        });
    </script>
</body>

</html>